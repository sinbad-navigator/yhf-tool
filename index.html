<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è£•å†œå¿«è´· - æ™ºèƒ½å‡†å…¥å·¥å…· (V12.5 æˆªå›¾ä¿®å¤ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- æ ¸å¿ƒè®¾è®¡å˜é‡ --- */
        :root {
            --primary-color: #2563eb;       /* æ ¸å¿ƒè“ */
            --primary-dark: #1e3a8a;        /* æ·±è“ */
            --accent-color: #f59e0b;        /* å¼ºè°ƒè‰²(æ©™) */
            --success-color: #10b981;       /* æˆåŠŸç»¿ */
            --danger-color: #ef4444;        /* è­¦æˆ’çº¢ */
            --bg-body: #f1f5f9;             /* é¡µé¢åº•è‰² */
            --card-radius: 12px;            /* å¡ç‰‡åœ†è§’ */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* å…¨å±€é‡ç½® */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: var(--bg-body);
            margin: 0;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            color: #334155;
        }

        /* å®¹å™¨ç¾åŒ– */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: transparent;
        }

        /* å¤´éƒ¨ Hero åŒºåŸŸ */
        .header-card {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            border-radius: var(--card-radius);
            padding: 25px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        .header-card::after {
            content: "";
            position: absolute;
            top: -50%; left: -20%; width: 200px; height: 200px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
        }
        .header-title { font-size: 1.4rem; font-weight: 700; margin: 0; letter-spacing: 1px; }
        .header-sub { font-size: 0.85rem; opacity: 0.9; margin-top: 8px; font-weight: 300; }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .section-box {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .section-icon {
            width: 4px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 2px;
            margin-right: 10px;
        }
        .section-title-text {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        /* ç»è¥ç”»åƒ - æ§åˆ¶å°é¢æ¿ */
        .slider-panel {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            border-radius: var(--card-radius);
            padding: 20px;
            margin-top: 20px;
        }
        .slider-header {
            display: flex; justify-content: space-between; align-items: center;
            color: #b45309; font-weight: 600; margin-bottom: 10px;
        }
        .calc-tags {
            display: flex; gap: 8px; margin-top: 10px; justify-content: flex-end;
        }
        .mini-tag {
            font-size: 11px; background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 4px; color: #92400e;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .stat-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-label { font-size: 12px; color: #64748b; margin-bottom: 4px; }
        .stat-val { font-size: 18px; font-weight: 700; color: #0f172a; font-family: 'DIN Alternate', sans-serif; }
        .stat-sub { font-size: 12px; color: var(--success-color); margin-top: 2px; }

        /* èµ„äº§è´Ÿå€º - åˆ†ç»„ */
        .asset-group { background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .debt-group { background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .group-label { font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 10px; display: block; }

        /* ç»“æœé¢æ¿ */
        .debt-panel {
            background: white;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .debt-row { display: flex; justify-content: space-around; align-items: center; }
        .debt-item { text-align: center; }
        .debt-label { font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .debt-val { font-size: 20px; font-weight: 800; font-family: 'DIN Alternate', sans-serif; }

        /* æŒ‰é’®ä¸è¾“å…¥æ¡†å¾®è°ƒ */
        .action-bar { display: flex; gap: 15px; margin-top: 20px; }
        .btn-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: all 0.2s; border: none; }
        .btn-shadow:active { transform: scale(0.98); box-shadow: none; }

        .el-form-item__label { font-weight: 500; color: #475569; }
        .el-input__wrapper { box-shadow: none !important; border: 1px solid #e2e8f0; background-color: #f8fafc; transition: all 0.3s; }
        .el-input__wrapper:hover, .el-input__wrapper.is-focus { border-color: var(--primary-color); background-color: white; }

        /* å‚è€ƒèŒƒå›´æ–‡å­—ç¾åŒ– */
        .input-suffix-text { font-size: 11px; color: #94a3b8; margin-top: 4px; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 6px; }
        .avg-tag { background: #f1f5f9; padding: 1px 5px; border-radius: 4px; color: #64748b; font-weight: 600; }

        @media screen and (max-width: 768px) {
            body { padding: 10px; background: #f8fafc; }
            .container { width: 100%; }
            .header-card { padding: 20px 15px; border-radius: 0 0 15px 15px; margin-top: -10px; box-shadow: none; }
            .stat-grid { gap: 10px; }
            .action-bar { flex-direction: column; gap: 10px; }
            .el-form-item { margin-bottom: 15px; }
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div id="capture-area">
        <div class="header-card">
            <h2 class="header-title">è£•å†œå¿«è´· Â· æ™ºèƒ½å‡†å…¥</h2>
            <div class="header-sub">V12.5 Pro | æ™ºèƒ½æµ‹ç®— Â· å‡å€¼å‚è€ƒ Â· é£é™©é€è§†</div>
        </div>

        <el-form :model="form" :label-width="isMobile ? 'auto' : '100px'" :label-position="isMobile ? 'top' : 'left'" size="default">

            <div class="section-box">
                <div class="section-header">
                    <div class="section-icon"></div>
                    <span class="section-title-text">å®¢æˆ·åŸºæœ¬ä¿¡æ¯</span>
                </div>
                <el-row :gutter="20">
                    <el-col :xs="24" :sm="12"><el-form-item label="å®¢æˆ·å§“å"><el-input v-model="form.name" placeholder="è¯·è¾“å…¥å§“å"></el-input></el-form-item></el-col>
                    <el-col :xs="24" :sm="12"><el-form-item label="èº«ä»½è¯å·"><el-input v-model="form.idCard" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"></el-input></el-form-item></el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :xs="24" :sm="12"><el-form-item label="è”ç³»ç”µè¯"><el-input v-model="form.phone" type="tel" placeholder="11ä½æ‰‹æœºå·"></el-input></el-form-item></el-col>
                    <el-col :xs="24" :sm="12"><el-form-item label="å±…ä½åœ°å€"><el-input v-model="form.address" placeholder="å¸¸ä½åœ°å€"></el-input></el-form-item></el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :xs="24" :sm="12"><el-form-item label="å©šå§»çŠ¶å†µ">
                        <el-select v-model="form.marriage" style="width:100%" placeholder="è¯·é€‰æ‹©">
                            <el-option value="å·²å©š" label="å·²å©š"></el-option>
                            <el-option value="æœªå©š" label="æœªå©š"></el-option>
                            <el-option value="ç¦»å¼‚" label="ç¦»å¼‚"></el-option>
                        </el-select>
                    </el-form-item></el-col>
                </el-row>
            </div>

            <div class="section-box">
                <div class="section-header">
                    <div class="section-icon" style="background: var(--accent-color);"></div>
                    <span class="section-title-text">ç»è¥ç”»åƒæµ‹ç®—</span>
                </div>

                <el-row :gutter="20">
                    <el-col :xs="24" :sm="12">
                        <el-form-item label="é€‰æ‹©äº§ä¸š">
                            <el-select v-model="form.cropType" @change="handleCropChange" style="width:100%">
                                <el-option v-for="(v, k) in cropDb" :key="k" :label="k" :value="k"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :xs="24" :sm="12"><el-form-item label="ç»†åˆ†å“ç§"><el-input v-model="currentCropVariety" disabled></el-input></el-form-item></el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :xs="24" :sm="12"><el-form-item label="ç§æ¤è§„æ¨¡(äº©)"><el-input-number v-model="form.area" :min="1" style="width:100%" @change="handleManualInput"></el-input-number></el-form-item></el-col>
                    <el-col :xs="24" :sm="12"><el-form-item label="ç§æ¤å¹´é™"><el-input-number v-model="form.years" :min="1" style="width:100%"></el-input-number></el-form-item></el-col>
                </el-row>

                <div class="slider-panel">
                    <div class="slider-header">
                        <span style="display:flex; align-items:center;">ğŸ›ï¸ æ”¶æ”¯æ¯”è°ƒèŠ‚æ§åˆ¶å°</span>
                        <span style="font-size: 20px; font-family: 'DIN Alternate';">{{ (realRatio * 100).toFixed(1) }}%</span>
                    </div>
                    <el-slider
                            v-model="sliderVal"
                            :min="10" :max="90" :step="0.1"
                            @input="handleSliderInput"
                            :disabled="lockCost && lockInc"
                            :show-tooltip="false"
                            size="small"
                            style="margin-bottom: 10px;">
                    </el-slider>
                    <div class="calc-tags">
                        <div class="mini-tag">æ¨¡å¼: {{ isMobile && lockStatusText.length > 10 ? 'é”å®š' : lockStatusText }}</div>
                        <div class="mini-tag">æ€»æ”¶: {{(totalFamilyIncome/10000).toFixed(2)}}w</div>
                        <div class="mini-tag">æ€»æ”¯: {{(totalFamilyCost/10000).toFixed(2)}}w</div>
                    </div>
                </div>

                <el-row :gutter="20" style="margin-top:20px;">
                    <el-col :xs="24" :sm="12">
                        <el-form-item label="äº©å‡æŠ•å…¥(å…ƒ)">
                            <el-input
                                    v-model.number="form.costPerMu"
                                    type="number"
                                    @input="() => { lockCost = true; handleManualInput(); }"
                                    placeholder="å¯æ‰‹è¾“">
                                <template #suffix>
                                    <el-checkbox v-model="lockCost" label="é”å®š" size="small" />
                                </template>
                            </el-input>
                            <div class="input-suffix-text">
                                <span>èŒƒå›´: {{currentRange.minCost}}-{{currentRange.maxCost}}</span>
                                <span class="avg-tag" v-if="currentRange.minCost">(å‡å€¼: {{ Math.round((currentRange.minCost + currentRange.maxCost) / 2) }})</span>
                            </div>
                        </el-form-item>
                    </el-col>
                    <el-col :xs="24" :sm="12">
                        <el-form-item label="äº©å‡äº§å‡º(å…ƒ)">
                            <el-input
                                    v-model.number="form.incomePerMu"
                                    type="number"
                                    @input="() => { lockInc = true; handleManualInput(); }"
                                    placeholder="å¯æ‰‹è¾“">
                                <template #suffix>
                                    <el-checkbox v-model="lockInc" label="é”å®š" size="small" />
                                </template>
                            </el-input>
                            <div class="input-suffix-text">
                                <span>èŒƒå›´: {{currentRange.minInc}}-{{currentRange.maxInc}}</span>
                                <span class="avg-tag" v-if="currentRange.minInc" style="color: var(--success-color); background:#ecfdf5;">(å‡å€¼: {{ Math.round((currentRange.minInc + currentRange.maxInc) / 2) }})</span>
                            </div>
                        </el-form-item>
                    </el-col>
                </el-row>

                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ“‰ å¹´ç»è¥æ€»æŠ•å…¥</div>
                        <div class="stat-val">{{ (form.area * form.costPerMu).toLocaleString() }}</div>
                        <div class="stat-sub">â‰ˆ {{ ((form.area * form.costPerMu) / 10000).toFixed(4) }} ä¸‡å…ƒ</div>
                    </div>
                    <div class="stat-card" style="background:#f0fdf4; border-color:#dcfce7;">
                        <div class="stat-label">ğŸ’° å¹´ç»è¥æ€»äº§å‡º</div>
                        <div class="stat-val" style="color:#15803d;">{{ (form.area * form.incomePerMu).toLocaleString() }}</div>
                        <div class="stat-sub">â‰ˆ {{ ((form.area * form.incomePerMu) / 10000).toFixed(4) }} ä¸‡å…ƒ</div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <el-button type="primary" plain round style="width: 100%; border-style: dashed;" @click="randomizeValues" :disabled="lockCost && lockInc">
                        ğŸ² æ™ºèƒ½è®¡ç®— / éšæœºå¾®è°ƒ
                    </el-button>
                </div>
            </div>

            <div class="section-box">
                <div class="section-header">
                    <div class="section-icon" style="background: var(--danger-color);"></div>
                    <span class="section-title-text">èµ„äº§ä¸è´Ÿå€ºç»“æ„</span>
                </div>

                <div class="asset-group">
                    <span class="group-label">ğŸ”µ èµ„äº§é¡¹ (å•ä½:ä¸‡å…ƒ)</span>
                    <el-row :gutter="15">
                        <el-col :xs="12" :sm="8"><el-form-item label="æˆ¿äº§"><el-input type="number" v-model="form.assetHouse"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="è½¦è¾†"><el-input type="number" v-model="form.assetCar"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="å­˜æ¬¾"><el-input type="number" v-model="form.assetDeposit"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="åœŸ/æ—"><el-input type="number" v-model="form.assetLand"></el-input></el-form-item></el-col>
                    </el-row>
                </div>

                <div class="debt-group">
                    <span class="group-label">ğŸ”´ è´Ÿå€ºé¡¹ (å•ä½:ä¸‡å…ƒ)</span>
                    <el-row :gutter="15">
                        <el-col :xs="12" :sm="8"><el-form-item label="ä»–è¡Œè´·"><el-input type="number" v-model="form.debtOtherBank"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="ä¿¡ç”¨å¡"><el-input type="number" v-model="form.debtCreditCard"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="æœ¬ç¬”è´·"><el-input type="number" v-model="form.applyAmount"></el-input></el-form-item></el-col>
                    </el-row>
                </div>

                <div style="padding: 10px; border-top: 1px solid #f1f5f9;">
                    <el-row :gutter="15">
                        <el-col :xs="12" :sm="8"><el-form-item label="ç”Ÿæ´»è´¹"><el-input type="number" v-model="form.livingCost" @input="handleManualInput"></el-input></el-form-item></el-col>
                        <el-col :xs="12" :sm="8"><el-form-item label="å‰¯ä¸šæ”¶"><el-input type="number" v-model="form.extraIncome" @input="handleManualInput"></el-input></el-form-item></el-col>
                    </el-row>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">* ç”Ÿæ´»è´¹ä¸å‰¯ä¸šæ”¶å…¥å°†è‡ªåŠ¨è®¡å…¥å®¶åº­æ”¶æ”¯æ¯”æµ‹ç®—</div>
                </div>

                <div class="debt-panel">
                    <div class="debt-row">
                        <div class="debt-item">
                            <div class="debt-label">æ€»èµ„äº§</div>
                            <div class="debt-val" style="color: var(--primary-color);">{{ totalAssets.toFixed(1) }}</div>
                        </div>
                        <div style="width: 1px; height: 30px; background: #e2e8f0;"></div>
                        <div class="debt-item">
                            <div class="debt-label">æ€»è´Ÿå€º</div>
                            <div class="debt-val" style="color: var(--danger-color);">{{ totalDebts.toFixed(1) }}</div>
                        </div>
                        <div style="width: 1px; height: 30px; background: #e2e8f0;"></div>
                        <div class="debt-item">
                            <div class="debt-label">è´Ÿå€ºç‡</div>
                            <div class="debt-val" :style="{color: debtRatio > 0.7 ? '#ef4444' : '#10b981'}">
                                {{ (debtRatio * 100).toFixed(1) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </el-form>
    </div>

    <div class="action-bar" id="bottom-actions">
        <el-button color="#2563eb" size="large" class="btn-shadow" style="flex: 1; height:48px; font-size:16px;" @click="exportImage">
            <span style="margin-right:5px;">ğŸ“¸</span> å¯¼å‡ºé•¿å›¾
        </el-button>
        <el-button color="#10b981" size="large" class="btn-shadow" style="flex: 1; height:48px; font-size:16px;" @click="exportExcel">
            <span style="margin-right:5px;">ğŸ“¥</span> ç”ŸæˆæŠ¥è¡¨
        </el-button>
    </div>

    <div style="height: 40px;"></div>
</div>

<script>
    const { createApp, reactive, computed, ref, onMounted, onUnmounted } = Vue;

    const CROP_DB = {
        "çƒ¤çƒŸ": { type: "å†œä¸š", variety: "çƒŸå¶", minCost: 3555, maxCost: 4920, minInc: 8000, maxInc: 10000, limit: 500000 },
        "æ‡æ·": { type: "å†œä¸š", variety: "æ‡æ·", minCost: 6850, maxCost: 7900, minInc: 14000, maxInc: 20000, limit: 100000 },
        "è‘¡è„": { type: "å†œä¸š", variety: "è‘¡è„ç±½", minCost: 15900, maxCost: 24500, minInc: 35000, maxInc: 40000, limit: 500000 },
        "è“è“": { type: "å†œä¸š", variety: "å…¶ä»–æ°´æœç±½", minCost: 25500, maxCost: 35000, minInc: 63000, maxInc: 100000, limit: 500000 }
    };

    const App = {
        setup() {
            // å“åº”å¼æ£€æµ‹å±å¹•å®½åº¦
            const isMobile = ref(window.innerWidth < 768);
            const updateWidth = () => { isMobile.value = window.innerWidth < 768; };
            onMounted(() => window.addEventListener('resize', updateWidth));
            onUnmounted(() => window.removeEventListener('resize', updateWidth));

            const form = reactive({
                name: 'æ¨ç»ç†',
                idCard: '53*************3',
                phone: '15*********5',
                address: 'äº‘å—çœçº¢æ²³å·è’™è‡ª',
                marriage: 'æœªå©š',
                cropType: 'è“è“',
                area: 10,
                years: 1,
                costPerMu: 32575,
                incomePerMu: 76341,
                assetHouse: 60, assetCar: 10, assetDeposit: 8, assetLand: 8, assetOther: 0,
                debtOtherBank: 0, debtCreditCard: 0, applyAmount: 30,
                livingCost: 4.1477, extraIncome: 0
            });

            const sliderVal = ref(48.1);
            const lockCost = ref(false);
            const lockInc = ref(false);

            const currentRange = computed(() => CROP_DB[form.cropType] || {});
            const currentCropVariety = computed(() => currentRange.value.variety || "");

            const totalAssets = computed(() => parseFloat(form.assetHouse || 0) + parseFloat(form.assetCar || 0) + parseFloat(form.assetDeposit || 0) + parseFloat(form.assetLand || 0) + parseFloat(form.assetOther || 0));
            const totalDebts = computed(() => parseFloat(form.debtOtherBank || 0) + parseFloat(form.debtCreditCard || 0) + parseFloat(form.applyAmount || 0));
            const debtRatio = computed(() => totalAssets.value ? totalDebts.value / totalAssets.value : 0);

            const operatingCost = computed(() => parseFloat(form.costPerMu || 0) * form.area);
            const operatingIncome = computed(() => parseFloat(form.incomePerMu || 0) * form.area);

            const totalFamilyCost = computed(() => operatingCost.value + (parseFloat(form.livingCost || 0) * 10000));
            const totalFamilyIncome = computed(() => operatingIncome.value + (parseFloat(form.extraIncome || 0) * 10000));

            const realRatio = computed(() => totalFamilyIncome.value === 0 ? 0 : totalFamilyCost.value / totalFamilyIncome.value);

            const lockStatusText = computed(() => {
                if(lockCost.value && lockInc.value) return "å…¨é”å®š";
                if(lockCost.value) return "é”å®šæŠ•å…¥";
                if(lockInc.value) return "é”å®šäº§å‡º";
                return "è‡ªåŠ¨æ¨¡å¼";
            });

            const handleCropChange = () => {
                lockCost.value = false;
                lockInc.value = false;
                solveForValues(sliderVal.value / 100);
            };

            const handleSliderInput = (val) => solveForValues(val / 100);

            const handleManualInput = () => {
                if(totalFamilyIncome.value > 0) {
                    const r = totalFamilyCost.value / totalFamilyIncome.value;
                    sliderVal.value = parseFloat((r * 100).toFixed(1));
                }
            };

            const randomizeValues = () => {
                solveForValues(sliderVal.value / 100, true);
                sliderVal.value = parseFloat((realRatio.value * 100).toFixed(1));
            };

            const solveForValues = (targetRatio, forceRandom = false) => {
                if (lockCost.value && lockInc.value) return;

                const range = currentRange.value;
                const area = form.area;
                const living = form.livingCost * 10000;
                const extra = form.extraIncome * 10000;

                if (lockCost.value) {
                    const fixedCost = form.costPerMu;
                    let num = (fixedCost * area) + living;
                    let den = targetRatio;
                    if(den === 0) den = 0.01;
                    let calcInc = ( (num / den) - extra ) / area;

                    if (calcInc < range.minInc) calcInc = range.minInc;
                    if (calcInc > range.maxInc) calcInc = range.maxInc;
                    form.incomePerMu = Math.floor(calcInc);
                    return;
                }

                if (lockInc.value) {
                    const fixedInc = form.incomePerMu;
                    let totalInc = (fixedInc * area) + extra;
                    let calcCost = ( (targetRatio * totalInc) - living ) / area;

                    if (calcCost < range.minCost) calcCost = range.minCost;
                    if (calcCost > range.maxCost) calcCost = range.maxCost;
                    form.costPerMu = Math.floor(calcCost);
                    return;
                }

                const attempts = forceRandom ? 50 : 20;
                for (let i = 0; i < attempts; i++) {
                    let randInc = Math.floor(Math.random() * (range.maxInc - range.minInc + 1) + range.minInc);
                    let totalInc = (randInc * area) + extra;
                    let derivedCost = ( (targetRatio * totalInc) - living ) / area;

                    if (derivedCost >= range.minCost && derivedCost <= range.maxCost) {
                        form.incomePerMu = randInc;
                        form.costPerMu = Math.floor(derivedCost);
                        return;
                    }
                }
                let midInc = Math.floor((range.minInc + range.maxInc) / 2);
                let totalInc = (midInc * area) + extra;
                let forcedCost = ( (targetRatio * totalInc) - living ) / area;
                if (forcedCost < range.minCost) forcedCost = range.minCost;
                if (forcedCost > range.maxCost) forcedCost = range.maxCost;
                form.incomePerMu = midInc;
                form.costPerMu = Math.floor(forcedCost);
            };

            // --- æ ¸å¿ƒä¿®å¤ï¼šä¼˜åŒ–åçš„å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½ ---
            const exportImage = () => {
                // 1. è·å–è¦æˆªå›¾çš„åŒºåŸŸ
                const element = document.getElementById('capture-area');

                // 2. æˆªå›¾é…ç½®
                html2canvas(element, {
                    useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                    scale: 2,      // æé«˜æ¸…æ™°åº¦
                    backgroundColor: '#f8fafc', // è®¾ç½®èƒŒæ™¯è‰²ä¸ç½‘é¡µèƒŒæ™¯ä¸€è‡´ï¼Œé¿å…é€æ˜

                    // 3. ã€å…³é”®ä¿®å¤ã€‘åœ¨å…‹éš†çš„ DOM ä¸Šè¿›è¡Œæ ·å¼ä¿®æ”¹
                    onclone: (clonedDoc) => {
                        const clonedApp = clonedDoc.getElementById('capture-area');

                        // å¤„ç† .el-input__wrapper (å¤–å±‚åŒ…è£¹å™¨)
                        // ç›®æ ‡ï¼šæ¶ˆé™¤èƒŒæ™¯è‰²å’Œé˜´å½±ï¼Œé¿å…é®æŒ¡æ–‡å­—ï¼Œå¹¶æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç®€å•çš„è¾¹æ¡†
                        const wrappers = clonedApp.querySelectorAll('.el-input__wrapper, .el-textarea__inner');
                        wrappers.forEach(w => {
                            w.style.backgroundColor = 'transparent'; // èƒŒæ™¯è®¾ä¸ºé€æ˜
                            w.style.boxShadow = 'none';            // ç§»é™¤é˜´å½±
                            w.style.border = '1px solid #dcdfe6';  // æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªç®€å•çš„è¾¹æ¡†
                            w.style.borderRadius = '4px';          // ä¿æŒåœ†è§’
                        });

                        // å¤„ç† .el-input__inner (å†…å±‚è¾“å…¥æ¡†æ–‡å­—)
                        // ç›®æ ‡ï¼šç¡®ä¿æ–‡å­—é¢œè‰²æ­£ç¡®ï¼Œå¹¶æ¸…ç©º placeholder ä»¥é˜²é‡å 
                        const inputs = clonedApp.querySelectorAll('.el-input__inner');
                        inputs.forEach(input => {
                            input.style.color = '#606266'; // å¼ºåˆ¶è®¾ç½®æ–‡å­—é¢œè‰²
                            // å¦‚æœè¾“å…¥æ¡†æœ‰å€¼ï¼Œæ¸…ç©º placeholder
                            if (input.value) {
                                input.setAttribute('placeholder', '');
                            }
                        });

                        // --- éšè—æ— å…³å…ƒç´  ---
                        // ç›®æ ‡ï¼šéšè—ä¸‹æ‹‰ç®­å¤´ã€å‰åç¼€å›¾æ ‡ç­‰ï¼Œç®€åŒ–æˆªå›¾å†…å®¹
                        const icons = clonedApp.querySelectorAll('.el-input__suffix, .el-input__prefix, .el-select__caret');
                        icons.forEach(el => el.style.display = 'none');
                    }
                }).then(canvas => {
                    // 4. å°† canvas è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                    canvas.toBlob(blob => {
                        saveAs(blob, `è£•å†œå¿«è´·_V12.5_${form.name}.png`);
                    });
                }).catch(err => {
                    console.error('æˆªå›¾å¤±è´¥:', err);
                    alert('æˆªå›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            };

            const exportExcel = async () => {
                const workbook = new ExcelJS.Workbook();
                const styleWrapIndent = { wrapText: true, vertical: 'middle', horizontal: 'left', indent: 1 };
                const styleCenter = { vertical: 'middle', horizontal: 'center', wrapText: true };
                const borderAll = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };

                const ws1 = workbook.addWorksheet('1.å®¢æˆ·ç»ç†å½•å…¥å°è´¦');
                ws1.columns = [{ width: 25 }, { width: 50 }];
                const sheet1Data = [
                    ["å­—æ®µåç§°", "å½•å…¥å†…å®¹"],
                    ["å®¢æˆ·å§“å", form.name], ["èº«ä»½è¯å·", form.idCard], ["ç”µè¯", form.phone], ["å±…ä½åœ°å€", form.address],
                    ["å©šå§»çŠ¶å†µ", form.marriage], ["äº§ä¸šç±»å‹", form.cropType], ["ç»†åˆ†å“ç§", currentCropVariety.value],
                    ["ç§æ¤è§„æ¨¡(äº©)", form.area], ["ç§æ¤å¹´é™(å¹´)", form.years],
                    ["äº©å‡æˆæœ¬(å…ƒ)", form.costPerMu], ["äº©å‡æ”¶å…¥(å…ƒ)", form.incomePerMu],
                    ["å¹´ç§æ¤æ€»æˆæœ¬(ä¸‡å…ƒ)", (operatingCost.value/10000).toFixed(4)], ["å¹´ç§æ¤æ€»æ”¶å…¥(ä¸‡å…ƒ)", (operatingIncome.value/10000).toFixed(4)],
                    ["æˆ¿äº§ä»·å€¼(ä¸‡)", form.assetHouse], ["è½¦è¾†ä»·å€¼(ä¸‡)", form.assetCar], ["å­˜æ¬¾ç†è´¢(ä¸‡)", form.assetDeposit], ["åœŸåœ°æ—åœ°(ä¸‡)", form.assetLand],
                    ["ä»–è¡Œè´·æ¬¾(ä¸‡)", form.debtOtherBank], ["ä¿¡ç”¨å¡(ä¸‡)", form.debtCreditCard], ["æœ¬æ¬¡ç”³è¯·(ä¸‡)", form.applyAmount],
                    ["ç”Ÿæ´»æˆæœ¬(ä¸‡)", form.livingCost], ["é¢å¤–æ”¶å…¥(ä¸‡)", form.extraIncome],
                    ["å®¶åº­æ€»æ”¯å‡º(ä¸‡)", (totalFamilyCost.value/10000).toFixed(4)], ["å®¶åº­æ€»æ”¶å…¥(ä¸‡)", (totalFamilyIncome.value/10000).toFixed(4)]
                ];
                sheet1Data.forEach((row, index) => {
                    const r = ws1.addRow(row);
                    const cellKey = r.getCell(1); const cellVal = r.getCell(2);
                    cellKey.border = borderAll; cellVal.border = borderAll;
                    cellKey.alignment = styleCenter; cellVal.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true, indent: 1 };
                    if(index === 0) {
                        r.font = { bold: true, size: 12 };
                        cellKey.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                        cellVal.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                    } else {
                        cellKey.font = { bold: true };
                        cellKey.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                    }
                });

                const ws2 = workbook.addWorksheet('2.äº§ä¸šå‚æ•°åº“(å‹¿åŠ¨)');
                ws2.addRow(["äº§ä¸šåç§°", "äº§ä¸šç±»å‹", "ç»†åˆ†å“ç§", "äº©å‡æˆæœ¬ä¸‹é™", "äº©å‡æˆæœ¬ä¸Šé™", "äº©å‡æ”¶å…¥ä¸‹é™", "äº©å‡æ”¶å…¥ä¸Šé™", "æŒ‡å¯¼é¢åº¦ä¸Šé™"]);
                for(let k in CROP_DB) {
                    let d = CROP_DB[k];
                    ws2.addRow([k, d.type, d.variety, d.minCost, d.maxCost, d.minInc, d.maxInc, d.limit]);
                }

                const ws3 = workbook.addWorksheet('3.é£é™©è¯„ä»·è¡¨(æ‰“å°)');
                ws3.columns = [{ width: 12 }, { width: 14 }, { width: 20 }, { width: 14 }, { width: 25 }];
                ws3.mergeCells('A1:E1'); const t1 = ws3.getCell('A1'); t1.value = 'â€œè£•å†œå¿«è´·â€é£é™©è¯„ä»·è¡¨'; t1.font = { size: 18, bold: true, name: 'å®‹ä½“' }; t1.alignment = styleCenter; t1.border = borderAll;
                ws3.mergeCells('A2:A7'); const t2 = ws3.getCell('A2'); t2.value = 'åŸºæœ¬æƒ…å†µ'; t2.alignment = styleCenter; t2.border = borderAll;

                const basicRows = [['å®¢æˆ·å§“å', form.name, 'èº«ä»½è¯å·ç ', form.idCard], ['ä»äº‹è¡Œä¸š', form.cropType, 'ç”µè¯', form.phone], ['ç§æ¤è§„æ¨¡', form.area + ' äº©', 'å±…ä½åœ°å€', form.address], ['è´·æ¬¾é¢åº¦', form.applyAmount + ' ä¸‡å…ƒ', 'æˆä¿¡æœŸé™', '36 ä¸ªæœˆ'], ['è´·æ¬¾ç”¨é€”', 'ç”Ÿäº§ç»è¥', '', ''], ['ç”³è´·ç±»å‹', '', '', '']];
                basicRows.forEach((r, idx) => {
                    let rowNum = idx + 2; ws3.getCell(`B${rowNum}`).value = r[0]; ws3.getCell(`C${rowNum}`).value = r[1]; ws3.getCell(`D${rowNum}`).value = r[2]; ws3.getCell(`E${rowNum}`).value = r[3];
                    ['B','C','D','E'].forEach(c => { let cell = ws3.getCell(c + rowNum); cell.border = borderAll; cell.alignment = c === 'B' || c === 'D' ? styleCenter : { ...styleWrapIndent, indent: 0, horizontal: 'center' }; cell.font = { size: 10, name: 'å®‹ä½“' }; });
                });
                ws3.mergeCells('C6:E6'); ws3.mergeCells('C7:E7');

                ws3.mergeCells('A8:E8'); ws3.getCell('A8').value = 'é£é™©è¯„ä»·ä¸åˆ†æ'; ws3.getCell('A8').font = { bold: true }; ws3.getCell('A8').alignment = { vertical: 'middle', horizontal: 'left', indent: 1 }; ws3.getCell('A8').border = borderAll; ws3.getCell('A8').fill = {type: 'pattern', pattern:'solid', fgColor:{argb:'FFF0F0F0'}};

                ws3.mergeCells('A9:E9'); ws3.getCell('A9').value = '1. å€Ÿæ¬¾äººç»è¥æƒ…å†µã€‚'; ws3.getCell('A9').border = borderAll; ws3.getCell('A9').alignment = styleWrapIndent;

                ws3.mergeCells('A10:E10'); ws3.getCell('A10').value = `å€Ÿæ¬¾äººä»äº‹ç»è¥è¡Œä¸šèŒƒå›´ï¼šâ˜‘å†œä¸š â–¡æ—ä¸š â–¡ç‰§ä¸š â–¡æ¸”ä¸š â–¡æ¶‰å†œäºŒã€ä¸‰äº§ä¸š â–¡å…¶ä»–è¡Œä¸šï¼š___ï¼Œ\nä¸Šä¸€å¹´åº¦ç»è¥æˆæœ¬ ${(operatingCost.value/10000).toFixed(2)} ä¸‡å…ƒï¼Œä¸Šä¸€å¹´åº¦ç»è¥æ”¶å…¥ ${(operatingIncome.value/10000).toFixed(2)} ä¸‡å…ƒï¼Œ\nâ–¡æ˜¯ â–¡å¦ è´­ä¹°å†œä¸šä¿é™©ï¼Œå…¶å®ƒ _______`; ws3.getCell('A10').border = borderAll; ws3.getCell('A10').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(10).height = 60;

                ws3.mergeCells('A11:E11'); ws3.getCell('A11').value = '2. å€Ÿæ¬¾äººèµ„äº§è´Ÿå€ºæƒ…å†µã€‚'; ws3.getCell('A11').border = borderAll; ws3.getCell('A11').alignment = styleWrapIndent;
                ws3.mergeCells('A12:E13'); ws3.getCell('A12').value = `â‘ å€Ÿæ¬¾äººå®¶åº­æ€»èµ„äº§ ${totalAssets.value} ä¸‡å…ƒï¼Œå…¶ä¸­ï¼šæˆ¿äº§ ${form.assetHouse} ä¸‡å…ƒï¼Œè½¦äº§ ${form.assetCar} ä¸‡å…ƒï¼Œå•†é“º 0 ä¸‡å…ƒï¼Œé‡‘èèµ„äº§ ${form.assetDeposit} ä¸‡å…ƒï¼ŒåœŸåœ°(æˆ–æ—åœ°) ${form.assetLand} ä¸‡å…ƒã€‚\nâ‘¡å€Ÿæ¬¾äººå®¶åº­æ€»è´Ÿå€º ${totalDebts.value} ä¸‡å…ƒï¼Œå…¶ä¸­ï¼šä»–è¡Œè´·æ¬¾ ${form.debtOtherBank} ä¸‡å…ƒï¼Œä¿¡ç”¨å¡ ${form.debtCreditCard} ä¸‡å…ƒï¼Œæœ¬æ¬¡æ‹Ÿç”³è¯· ${form.applyAmount} ä¸‡å…ƒã€‚\nâ‘¢å€Ÿæ¬¾äººå®¶åº­èµ„äº§è´Ÿå€ºæ¯”ä¸º ${(debtRatio.value*100).toFixed(1)}%ã€‚`; ws3.getCell('A12').border = borderAll; ws3.getCell('A12').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(12).height = 90;

                ws3.mergeCells('A14:E14'); ws3.getCell('A14').value = '3. ä¿¡ç”¨çŠ¶å†µï¼šå®¢æˆ·å·²é€šè¿‡è‡ªåŠ¨å®¡æ‰¹æ¨¡å‹ã€‚'; ws3.getCell('A14').border = borderAll; ws3.getCell('A14').alignment = styleWrapIndent;
                ws3.mergeCells('A15:E15'); ws3.getCell('A15').value = '4. å¿å€ºèƒ½åŠ›åˆ†æã€‚'; ws3.getCell('A15').border = borderAll; ws3.getCell('A15').alignment = styleWrapIndent;
                ws3.mergeCells('A16:E16'); ws3.getCell('A16').value = '6. å…¶å®ƒè¯´æ˜æƒ…å†µï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰'; ws3.getCell('A16').border = borderAll; ws3.getCell('A16').alignment = styleWrapIndent;

                ws3.mergeCells('A17:E20'); ws3.getCell('A17').value = `ç»è°ƒæŸ¥æ ¸å®ï¼Œå€Ÿæ¬¾äºº${form.name}ï¼Œå®¶åº­æ€»èµ„äº§ä¸º${totalAssets.value.toFixed(1)}ä¸‡å…ƒï¼Œå®¶åº­å­˜é‡æ€»è´Ÿå€º${totalDebts.value.toFixed(1)}ä¸‡å…ƒï¼Œ\nå«æ­¤æ¬¡ç”³è´·${form.applyAmount}ä¸‡å…ƒï¼Œå®¶åº­èµ„äº§è´Ÿå€ºæ¯”ä¸º${(debtRatio.value*100).toFixed(1)}%ã€‚ä¸Šä¸€å¹´åº¦å®¶åº­æ€»æ”¶å…¥ä¸º${(totalFamilyIncome.value/10000).toFixed(3)}ä¸‡å…ƒï¼Œ\nå®¶åº­æ€»æ”¯å‡ºä¸º${(totalFamilyCost.value/10000).toFixed(3)}ä¸‡å…ƒï¼ˆå«ç”Ÿæ´»æˆæœ¬ï¼‰ã€‚è¯¥å€Ÿæ¬¾äººç»è¥${form.cropType}${form.area}äº©ï¼Œç»è¥çŠ¶å†µç¨³å®šï¼Œç¬¦åˆæˆ‘è¡Œ\nå‡†å…¥æ¡ä»¶ã€‚`; ws3.getCell('A17').border = borderAll; ws3.getCell('A17').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(17).height = 110;

                const ws4 = workbook.addWorksheet('ä¼šå•†è¡¨');
                ws4.mergeCells('A1:F1'); ws4.getCell('A1').value = 'é™„ä»¶4       ä¸­å›½å»ºè®¾é“¶è¡Œä¿¡æ¯å»ºæ¡£ä¼šå•†è®°å½•'; ws4.getCell('A1').font = { size: 14, bold: true, name: 'å®‹ä½“' }; ws4.getCell('A1').alignment = styleCenter;
                ws4.mergeCells('A4:H18');
                const hsCell = ws4.getCell('A4');
                hsCell.value = `å®¢æˆ·${form.name}ï¼Œèº«ä»½è¯å·ç  ${form.idCard}ï¼›\nèŒä¸šå†œæ°‘ï¼Œä¸»è¦ç§æ¤${form.cropType}ï¼Œç§æ¤è§„æ¨¡${form.area}äº©ï¼Œç°å‘æˆ‘è¡Œç”³è¯·ç»è¥è´·æ¬¾${form.applyAmount}ä¸‡å…ƒï¼Œ\nç”¨äºç”Ÿäº§ç»è¥æ”¯å‡ºã€‚å®¢æˆ·åä¸‹è‡ªæœ‰æˆ¿äº§${form.assetHouse}ä¸‡å…ƒã€è½¦è¾†${form.assetCar}ä¸‡å…ƒã€é‡‘èèµ„äº§${form.assetDeposit}ä¸‡å…ƒã€æ—åœ°${form.assetLand}ä¸‡å…ƒã€‚\nç»æ ¸å®ç»è¥æµæ°´ï¼Œä¸Šä¸€å¹´åº¦ç»è¥æ”¶å…¥${(operatingIncome.value/10000).toFixed(3)}ä¸‡å…ƒã€æˆæœ¬${(operatingCost.value/10000).toFixed(3)}ä¸‡å…ƒï¼Œ\nå®¶åº­æ€»èµ„äº§${totalAssets.value}ä¸‡å…ƒã€æ€»è´Ÿå€º${totalDebts.value}ä¸‡å…ƒï¼Œèµ„äº§è´Ÿå€ºç‡${(debtRatio.value*100).toFixed(4)}%ï¼Œæ”¶å…¥ç¨³å®šï¼Œè¿˜æ¬¾èƒ½åŠ›è¾ƒå¥½ã€‚\n\n-----------------------------------------------------------------------------------\n\nåŒæ„å°†${form.name}å®¢æˆ·ä¿¡æ¯æäº¤è‡³ä¸‹ä¸€å®¡æ ¸ç¯èŠ‚ã€‚\nç†ç”±å¦‚ä¸‹ï¼šç»å®¢æˆ·ç»ç†ä¸Šé—¨æ ¸å®ï¼Œå®¢æˆ·ç»è¥æ­£å¸¸ï¼Œç§æ¤${form.cropType}${form.area}äº©ï¼Œç»è¥æ”¶å…¥ç¨³å®šï¼Œ\nè´·æ¬¾ç”¨é€”çœŸå®ä¸”ä¸ç»è¥è§„æ¨¡åŒ¹é…ï¼Œå®¶åº­èµ„äº§è´Ÿå€ºç»“æ„åˆç†ï¼Œè¿˜æ¬¾èƒ½åŠ›è¾ƒå¥½ï¼ŒåŒæ„ç”³è´·ã€‚`;

                const greenBorder = { style: 'medium', color: { argb: 'FF00B050' } };
                hsCell.border = { top: greenBorder, left: greenBorder, bottom: greenBorder, right: greenBorder };
                hsCell.alignment = { vertical: 'top', wrapText: true, horizontal: 'left', indent: 1 };
                hsCell.font = { name: 'å®‹ä½“', size: 12 };

                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `è£•å†œå¿«è´·_æ™ºèƒ½å‡†å…¥å·¥å…·yhf_${form.name}.xlsx`);
            };

            return {
                form, cropDb: CROP_DB, currentRange, currentCropVariety,
                totalAssets, totalDebts, debtRatio,
                operatingCost, operatingIncome,
                totalFamilyCost, totalFamilyIncome,
                sliderVal, realRatio, lockCost, lockInc, lockStatusText, isMobile,
                handleSliderInput, randomizeValues, handleCropChange, handleManualInput, exportExcel, exportImage
            };
        }
    };

    createApp(App).use(ElementPlus).mount('#app');
</script>
</body>
</html>
