
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è£•å†œå¿«è´· - æ™ºèƒ½å‡†å…¥å·¥å…· (V11.0 ç»ˆæå®Œæ•´ç‰ˆ)</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <script src="https://unpkg.com/element-plus"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; padding: 20px; }
    .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .header { text-align: center; border-bottom: 2px solid #409EFF; margin-bottom: 20px; padding-bottom: 10px; }

    .section-box { border: 1px solid #ebeef5; border-radius: 6px; padding: 20px; margin-bottom: 25px; position: relative; }
    .section-title { position: absolute; top: -12px; left: 15px; background: white; padding: 0 8px; font-weight: bold; color: #409EFF; font-size:15px; }

    /* æ»‘å—åŒºåŸŸæ ·å¼ */
    .slider-panel { background: #fdf6ec; padding: 20px; border-radius: 6px; border: 1px dashed #e6a23c; margin-top: 15px; }
    .calc-res { font-size: 12px; color: #909399; display: flex; justify-content: space-between; margin-top: 5px; }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .editable-input .el-input__wrapper { box-shadow: 0 0 0 1px #67C23A inset !important; }
    .input-suffix-text { font-size: 12px; color: #999; margin-top: 4px; }

    /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .summary-card { background-color: #f4f4f5; border: 1px solid #e9e9eb; border-radius: 4px; padding: 12px; text-align: center; }
    .summary-label { font-size: 13px; color: #909399; margin-bottom: 5px; }
    .summary-val { font-size: 18px; font-weight: bold; color: #303133; }
    .summary-sub { font-size: 12px; color: #67C23A; margin-top: 2px; font-weight: 500; }

    /* èµ„äº§è´Ÿå€ºç‡é¢æ¿ */
    .debt-panel { background-color: #ecf5ff; border: 1px solid #d9ecff; border-radius: 4px; padding: 15px; margin-top: 15px; }
    .debt-item { text-align: center; border-right: 1px solid #d9ecff; }
    .debt-item:last-child { border-right: none; }
    .debt-label { font-size: 13px; color: #606266; margin-bottom: 8px; }
    .debt-val { font-size: 20px; font-weight: bold; color: #303133; }
  </style>
</head>
<body>

<div id="app" class="container">
  <div class="header">
    <h2>è£•å†œå¿«è´· Â· æ™ºèƒ½å‡†å…¥å·¥å…· (V11.0 ç»ˆæç‰ˆ)</h2>
    <p style="font-size: 12px; color: #666;">æ”¯æŒï¼šç¦»å¼‚é€‰é¡¹ | ç‹¬ç«‹é”å®š | ç»è¥ä¸ç”Ÿæ´»æˆæœ¬åˆ†ç¦» | ç«–ç‰ˆå°è´¦å¯¼å‡º</p>
  </div>

  <el-form :model="form" label-width="110px" size="default">

    <div class="section-box">
      <span class="section-title">1. å®¢æˆ·åŸºæœ¬ä¿¡æ¯</span>
      <el-row :gutter="20">
        <el-col :span="12"><el-form-item label="å®¢æˆ·å§“å"><el-input v-model="form.name"></el-input></el-form-item></el-col>
        <el-col :span="12"><el-form-item label="èº«ä»½è¯å·"><el-input v-model="form.idCard"></el-input></el-form-item></el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12"><el-form-item label="è”ç³»ç”µè¯"><el-input v-model="form.phone"></el-input></el-form-item></el-col>
        <el-col :span="12"><el-form-item label="å±…ä½åœ°å€"><el-input v-model="form.address"></el-input></el-form-item></el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12"><el-form-item label="å©šå§»çŠ¶å†µ">
          <el-select v-model="form.marriage" style="width:100%">
            <el-option value="å·²å©š" label="å·²å©š"></el-option>
            <el-option value="æœªå©š" label="æœªå©š"></el-option>
            <el-option value="ç¦»å¼‚" label="ç¦»å¼‚"></el-option>
          </el-select>
        </el-form-item></el-col>
      </el-row>
    </div>

    <div class="section-box">
      <span class="section-title">2. ç»è¥ç”»åƒ (æ™ºèƒ½æµ‹ç®—)</span>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="é€‰æ‹©äº§ä¸š">
            <el-select v-model="form.cropType" @change="handleCropChange" style="width:100%">
              <el-option v-for="(v, k) in cropDb" :key="k" :label="k" :value="k"></el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12"><el-form-item label="ç»†åˆ†å“ç§"><el-input v-model="currentCropVariety" disabled></el-input></el-form-item></el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12"><el-form-item label="ç§æ¤è§„æ¨¡(äº©)"><el-input-number v-model="form.area" :min="1" style="width:100%" @change="handleManualInput"></el-input-number></el-form-item></el-col>
        <el-col :span="12"><el-form-item label="ç§æ¤å¹´é™"><el-input-number v-model="form.years" :min="1" style="width:100%"></el-input-number></el-form-item></el-col>
      </el-row>

      <el-divider content-position="left">æ”¶æ”¯æ§åˆ¶å° ({{ lockStatusText }})</el-divider>

      <div class="slider-panel">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:#d48806; margin-bottom:10px;">
          <span>âš™ï¸ ä¸Šä¸€å¹´åº¦å®¶åº­æ€»æ”¶æ”¯æ¯”</span>
          <span>{{ (realRatio * 100).toFixed(1) }}%</span>
        </div>
        <el-slider
                v-model="sliderVal"
                :min="10" :max="90" :step="0.1"
                @input="handleSliderInput"
                :disabled="lockCost && lockInc"
                :format-tooltip="val => val + '%'">
        </el-slider>
        <div class="calc-res">
          <span>å®¶åº­æ€»æ”¶å…¥: {{ (totalFamilyIncome/10000).toFixed(3) }} ä¸‡</span>
          <span>å®¶åº­æ€»æ”¯å‡º: {{ (totalFamilyCost/10000).toFixed(3) }} ä¸‡</span>
        </div>
        <div style="font-size: 12px; color: #909399; margin-top: 5px;">* æ»‘å—è°ƒèŠ‚åŒ…å«ï¼šç»è¥æ”¶æ”¯ + ç”Ÿæ´»æˆæœ¬ + é¢å¤–æ”¶å…¥</div>
      </div>

      <el-row :gutter="20" style="margin-top:20px;">
        <el-col :span="12">
          <el-form-item label="äº©å‡æŠ•å…¥">
            <el-input
                    v-model.number="form.costPerMu"
                    type="number"
                    class="editable-input"
                    @input="() => { lockCost = true; handleManualInput(); }"
                    placeholder="å¯æ‰‹è¾“">
              <template #suffix>
                <el-checkbox v-model="lockCost" label="é”å®š" size="small" border style="margin-right: -5px;"/>
              </template>
            </el-input>
            <div class="input-suffix-text">èŒƒå›´: {{currentRange.minCost}}-{{currentRange.maxCost}}</div>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="äº©å‡äº§å‡º">
            <el-input
                    v-model.number="form.incomePerMu"
                    type="number"
                    class="editable-input"
                    @input="() => { lockInc = true; handleManualInput(); }"
                    placeholder="å¯æ‰‹è¾“">
              <template #suffix>
                <el-checkbox v-model="lockInc" label="é”å®š" size="small" border style="margin-right: -5px;"/>
              </template>
            </el-input>
            <div class="input-suffix-text">èŒƒå›´: {{currentRange.minInc}}-{{currentRange.maxInc}}</div>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20" style="margin-bottom: 10px;">
        <el-col :span="12">
          <div class="summary-card">
            <div class="summary-label">ğŸ“Š å¹´ç§æ¤æ€»æŠ•å…¥ (çº¯ç»è¥)</div>
            <div class="summary-val">{{ (form.area * form.costPerMu).toLocaleString() }} å…ƒ</div>
            <div class="summary-sub">â‰ˆ {{ ((form.area * form.costPerMu) / 10000).toFixed(4) }} ä¸‡å…ƒ</div>
          </div>
        </el-col>
        <el-col :span="12">
          <div class="summary-card">
            <div class="summary-label">ğŸ’° å¹´ç§æ¤æ€»äº§å‡º (çº¯ç»è¥)</div>
            <div class="summary-val">{{ (form.area * form.incomePerMu).toLocaleString() }} å…ƒ</div>
            <div class="summary-sub">â‰ˆ {{ ((form.area * form.incomePerMu) / 10000).toFixed(4) }} ä¸‡å…ƒ</div>
          </div>
        </el-col>
      </el-row>

      <div style="text-align: right;">
        <el-button type="primary" plain size="small" @click="randomizeValues" :disabled="lockCost && lockInc">
          ğŸ² æ™ºèƒ½è®¡ç®— / éšæœºå¾®è°ƒ
        </el-button>
      </div>
    </div>

    <div class="section-box">
      <span class="section-title">3. èµ„äº§ä¸è´Ÿå€º</span>
      <el-row :gutter="10">
        <el-col :span="8"><el-form-item label="æˆ¿äº§(ä¸‡)"><el-input type="number" v-model="form.assetHouse"></el-input></el-form-item></el-col>
        <el-col :span="8"><el-form-item label="è½¦è¾†(ä¸‡)"><el-input type="number" v-model="form.assetCar"></el-input></el-form-item></el-col>
        <el-col :span="8"><el-form-item label="å­˜æ¬¾ç†è´¢"><el-input type="number" v-model="form.assetDeposit"></el-input></el-form-item></el-col>
      </el-row>
      <el-row :gutter="10">
        <el-col :span="8"><el-form-item label="åœŸåœ°æ—åœ°"><el-input type="number" v-model="form.assetLand"></el-input></el-form-item></el-col>
        <el-col :span="8"><el-form-item label="ä»–è¡Œè´·æ¬¾"><el-input type="number" v-model="form.debtOtherBank"></el-input></el-form-item></el-col>
        <el-col :span="8"><el-form-item label="ä¿¡ç”¨å¡"><el-input type="number" v-model="form.debtCreditCard"></el-input></el-form-item></el-col>
      </el-row>

      <div style="background:#f4f4f5; border-radius:4px; padding: 15px 10px 5px 10px; margin-top: 10px;">
        <el-row :gutter="10">
          <el-col :span="8"><el-form-item label="ç”Ÿæ´»æˆæœ¬(ä¸‡)"><el-input type="number" v-model="form.livingCost" @input="handleManualInput" placeholder="ç‹¬ç«‹è®¡ç®—"></el-input></el-form-item></el-col>
          <el-col :span="8"><el-form-item label="é¢å¤–æ”¶å…¥(ä¸‡)"><el-input type="number" v-model="form.extraIncome" @input="handleManualInput"></el-input></el-form-item></el-col>
          <el-col :span="8"><el-form-item label="æœ¬æ¬¡ç”³è¯·(ä¸‡)"><el-input type="number" v-model="form.applyAmount"></el-input></el-form-item></el-col>
        </el-row>
        <div style="font-size: 12px; color: #909399; text-align: center; margin-bottom: 10px;">æ³¨æ„ï¼šç”Ÿæ´»æˆæœ¬å’Œç»è¥æŠ•å…¥æ˜¯åˆ†å¼€çš„ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ±‡æ€»è®¡ç®—æ”¶æ”¯æ¯”ã€‚</div>
      </div>

      <div class="debt-panel">
        <el-row>
          <el-col :span="8" class="debt-item">
            <div class="debt-label">å®¶åº­æ€»èµ„äº§</div>
            <div class="debt-val" style="color: #409EFF;">{{ totalAssets.toFixed(1) }} <span style="font-size:12px;">ä¸‡å…ƒ</span></div>
          </el-col>
          <el-col :span="8" class="debt-item">
            <div class="debt-label">å®¶åº­æ€»è´Ÿå€º</div>
            <div class="debt-val" style="color: #F56C6C;">{{ totalDebts.toFixed(1) }} <span style="font-size:12px;">ä¸‡å…ƒ</span></div>
          </el-col>
          <el-col :span="8" class="debt-item">
            <div class="debt-label">å®¶åº­èµ„äº§è´Ÿå€ºç‡</div>
            <div class="debt-val" :style="{color: debtRatio > 0.7 ? '#F56C6C' : '#67C23A'}">
              {{ (debtRatio * 100).toFixed(2) }}%
            </div>
          </el-col>
        </el-row>
      </div>
    </div>

    <el-button type="success" size="large" style="width:100%; height:50px; font-size:16px; font-weight:bold; margin-top: 10px;" @click="exportExcel">
      ğŸ“¥ ä¸‹è½½æœ€ç»ˆç‰ˆ Excel (Sheet1ç«–ç‰ˆ+å®Œç¾æ ¼å¼)
    </el-button>

  </el-form>
</div>

<script>
  const { createApp, reactive, computed, ref, watch } = Vue;

  const CROP_DB = {
    "çƒ¤çƒŸ": { type: "å†œä¸š", variety: "çƒŸå¶", minCost: 4237, maxCost: 4920, minInc: 8000, maxInc: 10000, limit: 500000 },
    "æ‡æ·": { type: "å†œä¸š", variety: "æ‡æ·", minCost: 7375, maxCost: 7900, minInc: 14000, maxInc: 20000, limit: 100000 },
    "è‘¡è„": { type: "å†œä¸š", variety: "è‘¡è„ç±½", minCost: 20200, maxCost: 24500, minInc: 35000, maxInc: 40000, limit: 500000 },
    "è“è“": { type: "å†œä¸š", variety: "å…¶ä»–æ°´æœç±½", minCost: 32000, maxCost: 35000, minInc: 63000, maxInc: 100000, limit: 500000 }
  };

  const App = {
    setup() {
      const form = reactive({
        name: 'æ¨ç»ç†',
        idCard: '530000000000000003',
        phone: '135000000045',
        address: 'äº‘å—çœçº¢æ²³å·è’™è‡ª',
        marriage: 'æœªå©š',
        cropType: 'è“è“',
        area: 10,
        years: 1,
        // é»˜è®¤åˆå§‹å€¼
        costPerMu: 32575,
        incomePerMu: 76341,
        assetHouse: 60, assetCar: 10, assetDeposit: 8, assetLand: 8, assetOther: 0,
        debtOtherBank: 0, debtCreditCard: 0, applyAmount: 30,
        livingCost: 4.1477, extraIncome: 0
      });

      const sliderVal = ref(48.1);
      const lockCost = ref(false);
      const lockInc = ref(false);

      // åŸºç¡€æ•°æ®
      const currentRange = computed(() => CROP_DB[form.cropType] || {});
      const currentCropVariety = computed(() => currentRange.value.variety || "");

      // èµ„äº§è´Ÿå€ºè®¡ç®—
      const totalAssets = computed(() => parseFloat(form.assetHouse || 0) + parseFloat(form.assetCar || 0) + parseFloat(form.assetDeposit || 0) + parseFloat(form.assetLand || 0) + parseFloat(form.assetOther || 0));
      const totalDebts = computed(() => parseFloat(form.debtOtherBank || 0) + parseFloat(form.debtCreditCard || 0) + parseFloat(form.applyAmount || 0));
      const debtRatio = computed(() => totalAssets.value ? totalDebts.value / totalAssets.value : 0);

      // ç»è¥ä¸å®¶åº­æ”¶æ”¯è®¡ç®— (ä¸¥æ ¼åˆ†ç¦»)
      // 1. çº¯ç»è¥
      const operatingCost = computed(() => parseFloat(form.costPerMu || 0) * form.area);
      const operatingIncome = computed(() => parseFloat(form.incomePerMu || 0) * form.area);

      // 2. å®¶åº­æ€»è®¡ (ç”¨äºæ»‘å—å’Œæ¯”ç‡)
      const totalFamilyCost = computed(() => operatingCost.value + (parseFloat(form.livingCost || 0) * 10000));
      const totalFamilyIncome = computed(() => operatingIncome.value + (parseFloat(form.extraIncome || 0) * 10000));

      // 3. çœŸå®æ¯”ç‡
      const realRatio = computed(() => totalFamilyIncome.value === 0 ? 0 : totalFamilyCost.value / totalFamilyIncome.value);

      const lockStatusText = computed(() => {
        if(lockCost.value && lockInc.value) return "å·²å…¨éƒ¨é”å®šï¼Œä»…å¯æ‰‹åŠ¨è¾“å…¥";
        if(lockCost.value) return "æŠ•å…¥å·²é”å®šï¼Œè°ƒèŠ‚æ»‘å—å°†æ”¹å˜äº§å‡º";
        if(lockInc.value) return "äº§å‡ºå·²é”å®šï¼Œè°ƒèŠ‚æ»‘å—å°†æ”¹å˜æŠ•å…¥";
        return "å…¨è‡ªåŠ¨éšæœºæ¨¡å¼";
      });

      // --- äº¤äº’é€»è¾‘ ---

      const handleCropChange = () => {
        lockCost.value = false;
        lockInc.value = false;
        solveForValues(sliderVal.value / 100);
      };

      const handleSliderInput = (val) => solveForValues(val / 100);

      // æ‰‹åŠ¨æ”¹æ•°å­— -> åå‘æ›´æ–°æ»‘å—
      const handleManualInput = () => {
        if(totalFamilyIncome.value > 0) {
          const r = totalFamilyCost.value / totalFamilyIncome.value;
          sliderVal.value = parseFloat((r * 100).toFixed(1));
        }
      };

      const randomizeValues = () => {
        solveForValues(sliderVal.value / 100, true);
        sliderVal.value = parseFloat((realRatio.value * 100).toFixed(1));
      };

      // æ ¸å¿ƒæ±‚è§£å™¨
      const solveForValues = (targetRatio, forceRandom = false) => {
        if (lockCost.value && lockInc.value) return;

        const range = currentRange.value;
        const area = form.area;
        const living = form.livingCost * 10000;
        const extra = form.extraIncome * 10000;

        // å…¬å¼: Ratio = (OpCost + Living) / (OpInc + Extra)
        // OpCost = CostPerMu * Area
        // OpInc = IncPerMu * Area

        // åœºæ™¯1ï¼šé”å®šæŠ•å…¥ï¼Œç®—äº§å‡º
        // Ratio = (FixedCost*A + L) / (I*A + E)  =>  I = [ (FixedCost*A + L)/Ratio - E ] / A
        if (lockCost.value) {
          const fixedCost = form.costPerMu;
          let num = (fixedCost * area) + living;
          let den = targetRatio;
          if(den === 0) den = 0.01;
          let calcInc = ( (num / den) - extra ) / area;

          if (calcInc < range.minInc) calcInc = range.minInc;
          if (calcInc > range.maxInc) calcInc = range.maxInc;
          form.incomePerMu = Math.floor(calcInc);
          return;
        }

        // åœºæ™¯2ï¼šé”å®šäº§å‡ºï¼Œç®—æŠ•å…¥
        // Ratio = (C*A + L) / (FixedInc*A + E) => C = [ Ratio * (FixedInc*A + E) - L ] / A
        if (lockInc.value) {
          const fixedInc = form.incomePerMu;
          let totalInc = (fixedInc * area) + extra;
          let calcCost = ( (targetRatio * totalInc) - living ) / area;

          if (calcCost < range.minCost) calcCost = range.minCost;
          if (calcCost > range.maxCost) calcCost = range.maxCost;
          form.costPerMu = Math.floor(calcCost);
          return;
        }

        // åœºæ™¯3ï¼šå…¨è‡ªåŠ¨/éšæœº
        const attempts = forceRandom ? 50 : 20;
        for (let i = 0; i < attempts; i++) {
          let randInc = Math.floor(Math.random() * (range.maxInc - range.minInc + 1) + range.minInc);
          // æ ¹æ®éšæœºæ”¶å…¥ç®—éœ€è¦çš„æˆæœ¬
          let totalInc = (randInc * area) + extra;
          let derivedCost = ( (targetRatio * totalInc) - living ) / area;

          if (derivedCost >= range.minCost && derivedCost <= range.maxCost) {
            form.incomePerMu = randInc;
            form.costPerMu = Math.floor(derivedCost);
            return;
          }
        }
        // å…œåº•ï¼šå–ä¸­é—´å€¼
        let midInc = Math.floor((range.minInc + range.maxInc) / 2);
        let totalInc = (midInc * area) + extra;
        let forcedCost = ( (targetRatio * totalInc) - living ) / area;

        if (forcedCost < range.minCost) forcedCost = range.minCost;
        if (forcedCost > range.maxCost) forcedCost = range.maxCost;

        form.incomePerMu = midInc;
        form.costPerMu = Math.floor(forcedCost);
      };

      // ================= Excel ç”Ÿæˆé€»è¾‘ =================
      const exportExcel = async () => {
        const workbook = new ExcelJS.Workbook();
        const styleWrapIndent = { wrapText: true, vertical: 'middle', horizontal: 'left', indent: 1 };
        const styleCenter = { vertical: 'middle', horizontal: 'center', wrapText: true };
        const borderAll = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };

        // >>> Sheet 1: å®¢æˆ·ç»ç†å½•å…¥å°è´¦ (ç«–ç‰ˆ) <<<
        const ws1 = workbook.addWorksheet('1.å®¢æˆ·ç»ç†å½•å…¥å°è´¦');
        ws1.columns = [{ width: 25 }, { width: 50 }];
        const sheet1Data = [
          ["å­—æ®µåç§°", "å½•å…¥å†…å®¹"],
          ["å®¢æˆ·å§“å", form.name], ["èº«ä»½è¯å·", form.idCard], ["ç”µè¯", form.phone], ["å±…ä½åœ°å€", form.address],
          ["å©šå§»çŠ¶å†µ", form.marriage], ["äº§ä¸šç±»å‹", form.cropType], ["ç»†åˆ†å“ç§", currentCropVariety.value],
          ["ç§æ¤è§„æ¨¡(äº©)", form.area], ["ç§æ¤å¹´é™(å¹´)", form.years],
          ["äº©å‡æˆæœ¬(å…ƒ)", form.costPerMu], ["äº©å‡æ”¶å…¥(å…ƒ)", form.incomePerMu],
          ["å¹´ç§æ¤æ€»æˆæœ¬(ä¸‡å…ƒ)", (operatingCost.value/10000).toFixed(4)], ["å¹´ç§æ¤æ€»æ”¶å…¥(ä¸‡å…ƒ)", (operatingIncome.value/10000).toFixed(4)],
          ["æˆ¿äº§ä»·å€¼(ä¸‡)", form.assetHouse], ["è½¦è¾†ä»·å€¼(ä¸‡)", form.assetCar], ["å­˜æ¬¾ç†è´¢(ä¸‡)", form.assetDeposit], ["åœŸåœ°æ—åœ°(ä¸‡)", form.assetLand],
          ["ä»–è¡Œè´·æ¬¾(ä¸‡)", form.debtOtherBank], ["ä¿¡ç”¨å¡(ä¸‡)", form.debtCreditCard], ["æœ¬æ¬¡ç”³è¯·(ä¸‡)", form.applyAmount],
          ["ç”Ÿæ´»æˆæœ¬(ä¸‡)", form.livingCost], ["é¢å¤–æ”¶å…¥(ä¸‡)", form.extraIncome],
          ["å®¶åº­æ€»æ”¯å‡º(ä¸‡)", (totalFamilyCost.value/10000).toFixed(4)], ["å®¶åº­æ€»æ”¶å…¥(ä¸‡)", (totalFamilyIncome.value/10000).toFixed(4)]
        ];
        sheet1Data.forEach((row, index) => {
          const r = ws1.addRow(row);
          const cellKey = r.getCell(1); const cellVal = r.getCell(2);
          cellKey.border = borderAll; cellVal.border = borderAll;
          cellKey.alignment = styleCenter; cellVal.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true, indent: 1 };
          if(index === 0) {
            r.font = { bold: true, size: 12 };
            cellKey.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
            cellVal.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
          } else {
            cellKey.font = { bold: true };
            cellKey.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
          }
        });

        // >>> Sheet 2: äº§ä¸šå‚æ•°åº“ <<<
        const ws2 = workbook.addWorksheet('2.äº§ä¸šå‚æ•°åº“(å‹¿åŠ¨)');
        ws2.addRow(["äº§ä¸šåç§°", "äº§ä¸šç±»å‹", "ç»†åˆ†å“ç§", "äº©å‡æˆæœ¬ä¸‹é™", "äº©å‡æˆæœ¬ä¸Šé™", "äº©å‡æ”¶å…¥ä¸‹é™", "äº©å‡æ”¶å…¥ä¸Šé™", "æŒ‡å¯¼é¢åº¦ä¸Šé™"]);
        for(let k in CROP_DB) {
          let d = CROP_DB[k];
          ws2.addRow([k, d.type, d.variety, d.minCost, d.maxCost, d.minInc, d.maxInc, d.limit]);
        }

        // >>> Sheet 3: é£é™©è¯„ä»·è¡¨ (ä¸¥æ ¼åˆ†ç¦»ç»è¥å’Œå®¶åº­) <<<
        const ws3 = workbook.addWorksheet('3.é£é™©è¯„ä»·è¡¨(æ‰“å°)');
        ws3.columns = [{ width: 12 }, { width: 14 }, { width: 20 }, { width: 14 }, { width: 25 }];

        ws3.mergeCells('A1:E1');
        const t1 = ws3.getCell('A1'); t1.value = 'â€œè£•å†œå¿«è´·â€é£é™©è¯„ä»·è¡¨';
        t1.font = { size: 18, bold: true, name: 'å®‹ä½“' }; t1.alignment = styleCenter; t1.border = borderAll;

        ws3.mergeCells('A2:A7');
        const t2 = ws3.getCell('A2'); t2.value = 'åŸºæœ¬æƒ…å†µ'; t2.alignment = styleCenter; t2.border = borderAll;

        const basicRows = [
          ['å®¢æˆ·å§“å', form.name, 'èº«ä»½è¯å·ç ', form.idCard],
          ['ä»äº‹è¡Œä¸š', form.cropType, 'ç”µè¯', form.phone],
          ['ç§æ¤è§„æ¨¡', form.area + ' äº©', 'å±…ä½åœ°å€', form.address],
          ['è´·æ¬¾é¢åº¦', form.applyAmount + ' ä¸‡å…ƒ', 'æˆä¿¡æœŸé™', '36 ä¸ªæœˆ'],
          ['è´·æ¬¾ç”¨é€”', 'ç”Ÿäº§ç»è¥', '', ''],
          ['ç”³è´·ç±»å‹', '', '', '']
        ];
        basicRows.forEach((r, idx) => {
          let rowNum = idx + 2;
          ws3.getCell(`B${rowNum}`).value = r[0]; ws3.getCell(`C${rowNum}`).value = r[1]; ws3.getCell(`D${rowNum}`).value = r[2]; ws3.getCell(`E${rowNum}`).value = r[3];
          ['B','C','D','E'].forEach(c => {
            let cell = ws3.getCell(c + rowNum); cell.border = borderAll;
            cell.alignment = c === 'B' || c === 'D' ? styleCenter : { ...styleWrapIndent, indent: 0, horizontal: 'center' };
            cell.font = { size: 10, name: 'å®‹ä½“' };
          });
        });
        ws3.mergeCells('C6:E6'); ws3.mergeCells('C7:E7');

        ws3.mergeCells('A8:E8');
        ws3.getCell('A8').value = 'é£é™©è¯„ä»·ä¸åˆ†æ'; ws3.getCell('A8').font = { bold: true };
        ws3.getCell('A8').alignment = { vertical: 'middle', horizontal: 'left', indent: 1 };
        ws3.getCell('A8').border = borderAll; ws3.getCell('A8').fill = {type: 'pattern', pattern:'solid', fgColor:{argb:'FFF0F0F0'}};

        // 1. ç»è¥æƒ…å†µ (è¿™é‡Œåªæ˜¾ç¤ºçº¯ç»è¥æ”¶æ”¯)
        ws3.mergeCells('A9:E9');
        ws3.getCell('A9').value = '1. å€Ÿæ¬¾äººç»è¥æƒ…å†µã€‚'; ws3.getCell('A9').border = borderAll; ws3.getCell('A9').alignment = styleWrapIndent;

        ws3.mergeCells('A10:E10');
        ws3.getCell('A10').value = `å€Ÿæ¬¾äººä»äº‹ç»è¥è¡Œä¸šèŒƒå›´ï¼šâ˜‘å†œä¸š â–¡æ—ä¸š â–¡ç‰§ä¸š â–¡æ¸”ä¸š â–¡æ¶‰å†œäºŒã€ä¸‰äº§ä¸š â–¡å…¶ä»–è¡Œä¸šï¼š___ï¼Œ\nä¸Šä¸€å¹´åº¦ç»è¥æˆæœ¬ ${(operatingCost.value/10000).toFixed(2)} ä¸‡å…ƒï¼Œä¸Šä¸€å¹´åº¦ç»è¥æ”¶å…¥ ${(operatingIncome.value/10000).toFixed(2)} ä¸‡å…ƒï¼Œ\nâ–¡æ˜¯ â–¡å¦ è´­ä¹°å†œä¸šä¿é™©ï¼Œå…¶å®ƒ _______`;
        ws3.getCell('A10').border = borderAll; ws3.getCell('A10').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(10).height = 60;

        // 2. èµ„äº§è´Ÿå€º
        ws3.mergeCells('A11:E11'); ws3.getCell('A11').value = '2. å€Ÿæ¬¾äººèµ„äº§è´Ÿå€ºæƒ…å†µã€‚'; ws3.getCell('A11').border = borderAll; ws3.getCell('A11').alignment = styleWrapIndent;
        ws3.mergeCells('A12:E13');
        ws3.getCell('A12').value = `â‘ å€Ÿæ¬¾äººå®¶åº­æ€»èµ„äº§ ${totalAssets.value} ä¸‡å…ƒï¼Œå…¶ä¸­ï¼šæˆ¿äº§ ${form.assetHouse} ä¸‡å…ƒï¼Œè½¦äº§ ${form.assetCar} ä¸‡å…ƒï¼Œå•†é“º 0 ä¸‡å…ƒï¼Œé‡‘èèµ„äº§ ${form.assetDeposit} ä¸‡å…ƒï¼ŒåœŸåœ°(æˆ–æ—åœ°) ${form.assetLand} ä¸‡å…ƒã€‚\nâ‘¡å€Ÿæ¬¾äººå®¶åº­æ€»è´Ÿå€º ${totalDebts.value} ä¸‡å…ƒï¼Œå…¶ä¸­ï¼šä»–è¡Œè´·æ¬¾ ${form.debtOtherBank} ä¸‡å…ƒï¼Œä¿¡ç”¨å¡ ${form.debtCreditCard} ä¸‡å…ƒï¼Œæœ¬æ¬¡æ‹Ÿç”³è¯· ${form.applyAmount} ä¸‡å…ƒã€‚\nâ‘¢å€Ÿæ¬¾äººå®¶åº­èµ„äº§è´Ÿå€ºæ¯”ä¸º ${(debtRatio.value*100).toFixed(1)}%ã€‚`;
        ws3.getCell('A12').border = borderAll; ws3.getCell('A12').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(12).height = 90;

        ws3.mergeCells('A14:E14'); ws3.getCell('A14').value = '3. ä¿¡ç”¨çŠ¶å†µï¼šå®¢æˆ·å·²é€šè¿‡è‡ªåŠ¨å®¡æ‰¹æ¨¡å‹ã€‚'; ws3.getCell('A14').border = borderAll; ws3.getCell('A14').alignment = styleWrapIndent;
        ws3.mergeCells('A15:E15'); ws3.getCell('A15').value = '4. å¿å€ºèƒ½åŠ›åˆ†æã€‚'; ws3.getCell('A15').border = borderAll; ws3.getCell('A15').alignment = styleWrapIndent;
        ws3.mergeCells('A16:E16'); ws3.getCell('A16').value = '6. å…¶å®ƒè¯´æ˜æƒ…å†µï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰'; ws3.getCell('A16').border = borderAll; ws3.getCell('A16').alignment = styleWrapIndent;

        // 6. å…¶ä»–è¯´æ˜ (è¿™é‡Œæ˜¾ç¤ºå®¶åº­æ€»æ”¶æ”¯)
        ws3.mergeCells('A17:E20');
        ws3.getCell('A17').value = `ç»è°ƒæŸ¥æ ¸å®ï¼Œå€Ÿæ¬¾äºº${form.name}ï¼Œå®¶åº­æ€»èµ„äº§ä¸º${totalAssets.value.toFixed(1)}ä¸‡å…ƒï¼Œå®¶åº­å­˜é‡æ€»è´Ÿå€º${totalDebts.value.toFixed(1)}ä¸‡å…ƒï¼Œ\nå«æ­¤æ¬¡ç”³è´·${form.applyAmount}ä¸‡å…ƒï¼Œå®¶åº­èµ„äº§è´Ÿå€ºæ¯”ä¸º${(debtRatio.value*100).toFixed(1)}%ã€‚ä¸Šä¸€å¹´åº¦å®¶åº­æ€»æ”¶å…¥ä¸º${(totalFamilyIncome.value/10000).toFixed(3)}ä¸‡å…ƒï¼Œ\nå®¶åº­æ€»æ”¯å‡ºä¸º${(totalFamilyCost.value/10000).toFixed(3)}ä¸‡å…ƒï¼ˆå«ç”Ÿæ´»æˆæœ¬ï¼‰ã€‚è¯¥å€Ÿæ¬¾äººç»è¥${form.cropType}${form.area}äº©ï¼Œç»è¥çŠ¶å†µç¨³å®šï¼Œç¬¦åˆæˆ‘è¡Œ\nå‡†å…¥æ¡ä»¶ã€‚`;
        ws3.getCell('A17').border = borderAll; ws3.getCell('A17').alignment = { ...styleWrapIndent, vertical: 'top' }; ws3.getRow(17).height = 110;

        // >>> Sheet 4: ä¼šå•†è¡¨ <<<
        const ws4 = workbook.addWorksheet('ä¼šå•†è¡¨');
        ws4.mergeCells('A1:F1'); ws4.getCell('A1').value = 'é™„ä»¶4       ä¸­å›½å»ºè®¾é“¶è¡Œä¿¡æ¯å»ºæ¡£ä¼šå•†è®°å½•'; ws4.getCell('A1').font = { size: 14, bold: true, name: 'å®‹ä½“' }; ws4.getCell('A1').alignment = styleCenter;
        ws4.mergeCells('A4:H18');
        const hsCell = ws4.getCell('A4');
        // ä¼šå•†è¡¨æ¨¡æ¿
        hsCell.value = `å®¢æˆ·${form.name}ï¼Œèº«ä»½è¯å·ç  ${form.idCard}ï¼›\nèŒä¸šå†œæ°‘ï¼Œä¸»è¦ç§æ¤${form.cropType}ï¼Œç§æ¤è§„æ¨¡${form.area}äº©ï¼Œç°å‘æˆ‘è¡Œç”³è¯·ç»è¥è´·æ¬¾${form.applyAmount}ä¸‡å…ƒï¼Œ\nç”¨äºç”Ÿäº§ç»è¥æ”¯å‡ºã€‚å®¢æˆ·åä¸‹è‡ªæœ‰æˆ¿äº§${form.assetHouse}ä¸‡å…ƒã€è½¦è¾†${form.assetCar}ä¸‡å…ƒã€é‡‘èèµ„äº§${form.assetDeposit}ä¸‡å…ƒã€æ—åœ°${form.assetLand}ä¸‡å…ƒã€‚\nç»æ ¸å®ç»è¥æµæ°´ï¼Œä¸Šä¸€å¹´åº¦ç»è¥æ”¶å…¥${(operatingIncome.value/10000).toFixed(3)}ä¸‡å…ƒã€æˆæœ¬${(operatingCost.value/10000).toFixed(3)}ä¸‡å…ƒï¼Œ\nå®¶åº­æ€»èµ„äº§${totalAssets.value}ä¸‡å…ƒã€æ€»è´Ÿå€º${totalDebts.value}ä¸‡å…ƒï¼Œèµ„äº§è´Ÿå€ºç‡${(debtRatio.value*100).toFixed(4)}%ï¼Œæ”¶å…¥ç¨³å®šï¼Œè¿˜æ¬¾èƒ½åŠ›è¾ƒå¥½ã€‚\n\n-----------------------------------------------------------------------------------\n\nåŒæ„å°†${form.name}å®¢æˆ·ä¿¡æ¯æäº¤è‡³ä¸‹ä¸€å®¡æ ¸ç¯èŠ‚ã€‚\nç†ç”±å¦‚ä¸‹ï¼šç»å®¢æˆ·ç»ç†ä¸Šé—¨æ ¸å®ï¼Œå®¢æˆ·ç»è¥æ­£å¸¸ï¼Œç§æ¤${form.cropType}${form.area}äº©ï¼Œç»è¥æ”¶å…¥ç¨³å®šï¼Œ\nè´·æ¬¾ç”¨é€”çœŸå®ä¸”ä¸ç»è¥è§„æ¨¡åŒ¹é…ï¼Œå®¶åº­èµ„äº§è´Ÿå€ºç»“æ„åˆç†ï¼Œè¿˜æ¬¾èƒ½åŠ›è¾ƒå¥½ï¼ŒåŒæ„ç”³è´·ã€‚`;

        const greenBorder = { style: 'medium', color: { argb: 'FF00B050' } };
        hsCell.border = { top: greenBorder, left: greenBorder, bottom: greenBorder, right: greenBorder };
        hsCell.alignment = { vertical: 'top', wrapText: true, horizontal: 'left', indent: 1 };
        hsCell.font = { name: 'å®‹ä½“', size: 12 };

        // å¯¼å‡ºæ–‡ä»¶
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `è£•å†œå¿«è´·_æ™ºèƒ½å‡†å…¥å·¥å…·yhf_${form.name}.xlsx`);
      };

      // åˆå§‹åŒ–
      randomizeValues();

      return {
        form, cropDb: CROP_DB, currentRange, currentCropVariety,
        totalAssets, totalDebts, debtRatio,
        operatingCost, operatingIncome, // çº¯ç»è¥
        totalFamilyCost, totalFamilyIncome, // å®¶åº­æ€»è®¡
        sliderVal, realRatio, lockCost, lockInc, lockStatusText,
        handleSliderInput, randomizeValues, handleCropChange, handleManualInput, exportExcel
      };
    }
  };

  createApp(App).use(ElementPlus).mount('#app');
</script>
</body>
</html>
